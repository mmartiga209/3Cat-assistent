<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>Assistent llibre d'estil 3Cat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px auto;
      max-width: 800px;
      padding: 20px;
      background-color: #f8f8f8;
    }
    h2 {
      text-align: center;
    }
    label, textarea, button {
      display: block;
      width: 100%;
      margin-top: 20px;
    }
    textarea {
      height: 200px;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      padding: 12px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .resposta {
      margin-top: 30px;
      padding: 20px;
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 12px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f5f5f5;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 14px;
      color: #333;
    }
    tr:hover {
      background-color: #fafafa;
    }
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: bold;
    }
    .badge-si { background: #e6f4ea; color: #137333; }
    .badge-no { background: #fce8e6; color: #a50e0e; }
    .badge-na { background: #eef2f7; color: #3c4043; }
    .key {
      font-weight: bold;
      text-transform: capitalize;
    }

  </style>
</head>
<body>
  <h2>Assistent llibre d'estil 3Cat</h2>


  <label for="noticia">Enganxa (cut&paste) o posa un link que porti a la notÃ­cia:</label>
  <textarea id="noticia" placeholder="Enganxa aquÃ­ el text de la notÃ­cia..."></textarea>
  <button onclick="analitzar()">Processa la notÃ­cia</button>

  <div class="resposta">
    <h3>ðŸ“Š Resultats de l'avaluaciÃ³</h3>
    <div id="taulaGeneral">Esperant entrada...</div>
  </div>



<script>
  const API_BASE = "http://localhost:5000";

  // Optional: force a fixed row order
  const ORDER = ["pluralisme","diversitat","minories","paritat","compromis","veracitat","imparcialitat"];

  async function analitzar() {
    const text = document.getElementById("noticia").value.trim();
    const contenedor = document.getElementById("taulaGeneral");
    const btn = document.querySelector("button[onclick='analitzar()']");

    if (!text) {
      contenedor.textContent = "Cal introduir una notÃ­cia.";
      return;
    }

    contenedor.textContent = "Analitzant notÃ­cia (depenent del model pot trigar alguns minuts)...";
    btn.disabled = true;

    try {
      const resultats = await cridaBackend("/analisigeneral", text);
      console.log("Resposta del backend:", resultats);

      contenedor.innerHTML = construeixTaula(resultats);
    } catch (error) {
      contenedor.textContent = "Error: " + error.message;
    } finally {
      btn.disabled = false;
    }
  }

  async function cridaBackend(endpoint, text) {
    const resposta = await fetch(API_BASE + endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    if (!resposta.ok) {
      const error = await resposta.json().catch(() => ({}));
      throw new Error(error.detail || "Error en la resposta del servidor");
    }
    return await resposta.json();
  }

  function construeixTaula(resultats) {
    if (!resultats || typeof resultats !== "object" || Object.keys(resultats).length === 0) {
      return "<p>Sense resultats.</p>";
    }

    // Build an ordered list of [key, value] pairs
    const entries = Object.entries(resultats);
    entries.sort((a, b) => {
      const ia = ORDER.indexOf(a[0]);
      const ib = ORDER.indexOf(b[0]);
      return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
    });

    let rows = "";
    for (const [criteri, valor] of entries) {
      const complimentRaw = (valor?.compliment ?? "");
      const compliment = normalize(complimentRaw);
      const comentari = valor?.comentari || "";

      const badgeClasses = {
        "si": "badge-si",         // sÃ­/si (normalized)
        "no": "badge-no",
        "no aplica": "badge-na"
      };
      const badgeClass = badgeClasses[compliment] || "badge-na";
      const badgeText = complimentRaw || "â€”";

      rows += `
        <tr>
          <td class="key">${escapeHtml(criteri)}</td>
          <td><span class="badge ${badgeClass}">${escapeHtml(badgeText)}</span></td>
          <td>${escapeHtml(comentari)}</td>
        </tr>
      `;
    }

    return `
      <table>
        <thead>
          <tr>
            <th>Criteri</th>
            <th>Compliment</th>
            <th>Comentari</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    `;
  }

  // Normalize to lowercase, strip accents
  function normalize(str) {
    return String(str)
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // remove diacritics
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>


</body>
</html>
