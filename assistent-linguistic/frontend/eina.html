<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistent lingüísitc 3Cat</title>
  <style>
    :root{
      --fons:#f8f8f8;
      --card:#ffffff;
      --borda:#ddd;
      --borda-suau:#eee;
      --primari:#007bff;
      --primari-hover:#0056b3;
      --text:#222;
      --muted:#666;
      --ok:#137333;
      --ok-bg:#e6f4ea;
      --ko:#a50e0e;
      --ko-bg:#fce8e6;
      --warn:#7a5800;
      --warn-bg:#fff4ce;
    }
    *{box-sizing:border-box}
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 40px auto;
      max-width: 980px;
      padding: 20px;
      background-color: var(--fons);
      color: var(--text);
      line-height: 1.45;
    }
    h2, h3 { text-align: center; margin: 0 0 10px; }
    p.desc { text-align:center; color: var(--muted); margin: 0 0 24px; }
    label { font-weight: 600; display:block; margin-top: 10px; }
    .fila-entrada{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 780px){
      .fila-entrada{ grid-template-columns: 1fr 1fr; }
    }
    textarea, input[type="text"], select {
      width: 100%;
      padding: 12px 14px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      outline: none;
    }
    textarea { height: 220px; resize: vertical; }
    .ajuda { margin-top: 6px; font-size: 13px; color: var(--muted); }
    button {
      padding: 12px 16px;
      font-size: 16px;
      background-color: var(--primari);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      min-width: 210px;
      align-self: start;
    }
    button:hover { background-color: var(--primari-hover); }
    button:disabled { opacity:.7; cursor:not-allowed; }
    .carrega{ display:inline-flex; align-items:center; gap:10px; }
    .spinner{
      width: 18px; height: 18px; border: 3px solid #fff; border-top-color: transparent;
      border-radius: 50%; animation: gir 0.8s linear infinite;
    }
    @keyframes gir{to{transform:rotate(360deg)}}

    .resposta, .bloc {
      margin-top: 28px;
      padding: 20px;
      background-color: var(--card);
      border: 1px solid var(--borda);
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    .muted { color: var(--muted); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    th, td {
      border-bottom: 1px solid var(--borda-suau);
      padding: 12px;
      text-align: left;
      vertical-align: top;
      font-size: 15px;
    }
    th {
      background-color: #f5f5f5;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 13px;
      color: #333;
      letter-spacing: .02em;
    }
    tr:hover { background-color: #fafafa; }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 700;
    }
    .badge-si { background: var(--ok-bg); color: var(--ok); }
    .badge-no { background: var(--ko-bg); color: var(--ko); }
    .badge-ar { background: var(--warn-bg); color: var(--warn); }
    .badge-na { background: #eef2f7; color: #3c4043; }

    .key { font-weight: 700; text-transform: capitalize; }

    .errors {
      margin-top: 10px;
      color: var(--ko);
      background: #fdecea;
      border: 1px solid #f5c2c0;
      padding: 10px 12px;
      border-radius: 8px;
      display:none;
    }
    .ok {
      margin-top: 10px;
      color: var(--ok);
      background: #e7f3ec;
      border: 1px solid #b7dfc8;
      padding: 10px 12px;
      border-radius: 8px;
      display:none;
    }
    pre.code {
      white-space: pre-wrap;
      word-break: break-word;
      background: #fafafa;
      border: 1px solid var(--borda-suau);
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
    }
    .capsa-cap {
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top: 6px;
    }
    .btn-copia {
      font-size: 13px; padding: 8px 10px; border-radius: 8px; border:1px solid var(--borda); background:#fff; color:#111; cursor:pointer;
    }
    .btn-copia:hover { background:#f5f5f5; }

    /* [NOU: FRASE] estils específics */
    .frase-header{
      display:grid; gap:10px; margin-top:20px;
    }
    @media (min-width:760px){
      .frase-header{ grid-template-columns: 2fr 1fr; align-items:start; }
    }
    .kpis{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi{
      padding:10px 12px; border:1px solid var(--borda); border-radius:10px; background:#fff; font-weight:700;
    }
    .criteri-card{
      border:1px solid var(--borda); border-radius:12px; padding:14px; margin-top:14px; background:#fff;
    }
    .criteri-cap{
      display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;
    }
    .grid-2{
      display:grid; gap:10px;
    }
    @media (min-width:760px){
      .grid-2{ grid-template-columns: 1fr 1fr; }
    }
    .etiqueta{ font-size:12px; font-weight:700; text-transform:uppercase; color:#555; letter-spacing:.03em; }
    /* [NOU: COMES] estils específics */
    .comes-header{
      display:grid; gap:10px; margin-top:20px;
    }
    @media (min-width:760px){
      .comes-header{ grid-template-columns: 2fr 1fr; align-items:start; }
    }
    .legend{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; font-size:13px; color:#555;
    }
    .legend .tag{ border:1px solid var(--borda); border-radius:8px; padding:4px 8px; background:#fff; }
    .kpis{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi{
      padding:10px 12px; border:1px solid var(--borda); border-radius:10px; background:#fff; font-weight:700;
    }
    .criteri-card{
      border:1px solid var(--borda); border-radius:12px; padding:14px; margin-top:14px; background:#fff;
    }
    .criteri-cap{
      display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;
    }
    .grid-2{
      display:grid; gap:10px;
    }
    @media (min-width:760px){
      .grid-2{ grid-template-columns: 1fr 1fr; }
    }
    .etiqueta{ font-size:12px; font-weight:700; text-transform:uppercase; color:#555; letter-spacing:.03em; }

    /* ressaltat de comes als exemples */
    mark.coma-add { background:#e6f4ea; padding:0 2px; border-radius:3px; }
    mark.coma-del { background:#fce8e6; padding:0 2px; border-radius:3px; }
    mark.coma-plain { background:#fff4ce; padding:0 2px; border-radius:3px; }

  </style>
</head>
<body>
  <h2>Assistent llibre d'estil 3Cat</h2>
  <p class="desc">Prem <kbd>Ctrl</kbd>/<kbd>⌘</kbd> + <kbd>Enter</kbd> per processar.</p>

  <div class="fila-entrada">
    <div>
      <label for="noticia">Text o enllaç de la notícia</label>
      <textarea id="noticia" placeholder="Enganxa aquí el text de la notícia o un enllaç (http...)"></textarea>
      <div class="ajuda">Si detectem un URL, també l’enviarem al backend perquè el pugui tractar com a font.</div>
    </div>
    <div>
      <label for="api">Servidor API</label>
      <input id="api" type="text" value="http://localhost:5000" />

      <label for="endpointSel">Tipus d’anàlisi</label>
      <select id="endpointSel">
        <option value="/analisi/estil">Estil (/analisi/estil)</option>
        <option value="/analisi/frase">Frase (/analisi/frase)</option>
        <option value="/analisi/comes">Comes (/analisi/comes)</option>
      </select>
      <div class="ajuda">Selecciona quin endpoint vols cridar. Pots canviar el servidor a dalt.</div>

      <button id="btnProcessa" type="button">Processa la notícia</button>
      <div id="estat" class="ajuda muted" aria-live="polite">Esperant entrada…</div>
      <div id="err" class="errors"></div>
      <div id="ok" class="ok"></div>
    </div>
  </div>

  <div id="sortida"></div>

<script>
  // ─────────────────────────────────────────────────────────────────────────────
  // Configuració bàsica i utilitats d’UI
  // ─────────────────────────────────────────────────────────────────────────────
  const ORDER_ANTIC = ["pluralisme","diversitat","minories","paritat","compromis","veracitat","imparcialitat"];
  const $ = (sel, root=document) => root.querySelector(sel);

  $("#btnProcessa").addEventListener("click", analitzar);
  $("#noticia").addEventListener("keydown", (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter"){
      e.preventDefault();
      analitzar();
    }
  });

  function setEstat(text, tipus="neutral"){
    const estat = $("#estat");
    estat.textContent = text || "";
    estat.classList.remove("muted");
    if (tipus === "neutral") estat.classList.add("muted");
  }
  function mostraError(msg){
    const box = $("#err");
    box.textContent = msg;
    box.style.display = "block";
    $("#ok").style.display = "none";
  }
  function mostraOk(msg){
    const box = $("#ok");
    box.textContent = msg;
    box.style.display = "block";
    $("#err").style.display = "none";
  }
  function netejaAlertes(){
    $("#err").style.display = "none";
    $("#ok").style.display = "none";
  }
  function activaCarrega(btn, carregant=true){
    if (!btn) return;
    btn.disabled = carregant;
    if (carregant){
      btn.innerHTML = `<span class="carrega"><span class="spinner" aria-hidden="true"></span>Processant…</span>`;
    } else {
      btn.textContent = "Processa la notícia";
    }
  }
  function normalitza(str) {
    return String(str)
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }
  function escapaHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
  function preparaCos(entrada){
    const esUrl = /^(https?:\/\/[^\s]+)$/i.test(entrada);
    const cos = { text: entrada };
    if (esUrl) cos.url = entrada;
    return cos;
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // Flux principal
  // ─────────────────────────────────────────────────────────────────────────────
  async function analitzar() {
    netejaAlertes();
    const textEntrada = $("#noticia").value.trim();
    const btn = $("#btnProcessa");
    const API_BASE = ($("#api").value || "http://localhost:5000").replace(/\/+$/,"");
    const endpoint = $("#endpointSel").value || "/analisi/estil";

    if (!textEntrada) {
      setEstat("Cal introduir text o un enllaç.");
      return;
    }

    setEstat(`Analitzant notícia a ${endpoint}…`);
    activaCarrega(btn, true);

    try {
      const cos = preparaCos(textEntrada);
      const data = await cridaBackend(API_BASE, endpoint, cos);
      console.log("Resposta backend:", data);

      // [NOU: FRASE] branching per endpoint
      renderPerEndpoint(endpoint, data);

      setEstat("Anàlisi completada.", "neutral");
      mostraOk(`S’ha processat la notícia correctament (${endpoint}).`);
    } catch (error) {
      console.error(error);
      $("#sortida").innerHTML = "";
      mostraError(error.message || "Error desconegut en processar la notícia.");
      setEstat("S’ha produït un error.");
    } finally {
      activaCarrega(btn, false);
    }
  }

  async function cridaBackend(base, endpoint, cos) {
    const url = base + endpoint;
    const resposta = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(cos)
    });

    let payload = null;
    try {
      payload = await resposta.json();
    } catch {
      throw new Error(`La resposta del servidor no és JSON vàlid (HTTP ${resposta.status}).`);
    }

    if (!resposta.ok) {
      const detall = payload && (payload.detail || payload.error || payload.message);
      throw new Error(detall || `Error del servidor (HTTP ${resposta.status}).`);
    }
    return payload;
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // Render per endpoint
  // ─────────────────────────────────────────────────────────────────────────────
function renderPerEndpoint(endpoint, res){
  const sortida = $("#sortida");
  sortida.innerHTML = "";

  if (endpoint === "/analisi/estil"){
    if (esRespostaNova(res)) {
      sortida.appendChild(blocAnalisiGlobal(res.analisi_global));
      sortida.appendChild(blocAvaluacioPerCriteri(res.avaluacio_per_criteri));
      sortida.appendChild(blocVersioOptimitzada(res.versio_optimitzada));
    } else if (esDiccionariAntic(res)) {
      const bloc = document.createElement("div");
      bloc.className = "resposta";
      bloc.innerHTML = `<h3>📊 Resultats (format antic)</h3>${construeixTaulaAntiga(res) || "<p>Sense resultats.</p>"}`;
      sortida.appendChild(bloc);
    } else {
      sortida.appendChild(blocJSON(res));
    }
    return;
  }

  if (endpoint === "/analisi/frase"){
    if (esRespostaNova(res)) {
      sortida.appendChild(renderRespostaFrase(res));
    } else {
      sortida.appendChild(blocJSON(res));
    }
    return;
  }

  if (endpoint === "/analisi/comes"){ // [NOU: COMES]
    if (esRespostaNova(res)) {
      sortida.appendChild(renderRespostaComes(res));
    } else if (esDiccionariAntic(res)) {
      const bloc = document.createElement("div");
      bloc.className = "resposta";
      bloc.innerHTML = `<h3>📊 Resultats (format antic)</h3>${construeixTaulaAntiga(res) || "<p>Sense resultats.</p>"}`;
      sortida.appendChild(bloc);
    } else {
      sortida.appendChild(blocJSON(res));
    }
    return;
  }

  // Per a qualsevol altre: compatibilitat bàsica + JSON
  if (esDiccionariAntic(res)) {
    const bloc = document.createElement("div");
    bloc.className = "resposta";
    bloc.innerHTML = `<h3>📊 Resultats (format antic)</h3>${construeixTaulaAntiga(res) || "<p>Sense resultats.</p>"}`;
    sortida.appendChild(bloc);
  } else {
    sortida.appendChild(blocJSON(res));
  }
}

  // ─────────────────────────────────────────────────────────────────────────────
  // Render genèric existent
  // ─────────────────────────────────────────────────────────────────────────────
  function esRespostaNova(obj){
    if (!obj || typeof obj !== "object") return false;
    const teAnalisi = typeof obj.analisi_global === "string";
    const teAvaluacio = Array.isArray(obj.avaluacio_per_criteri);
    const teVersio = typeof obj.versio_optimitzada === "string";
    return teAnalisi && teAvaluacio && teVersio;
  }

  function esDiccionariAntic(obj){
    if (!obj || typeof obj !== "object" || Array.isArray(obj)) return false;
    const vals = Object.values(obj);
    if (vals.length === 0) return false;
    return vals.every(v => v && typeof v === "object" && ("compliment" in v || "comentari" in v));
  }

  function blocAnalisiGlobal(text){
    const d = document.createElement("div");
    d.className = "bloc";
    d.innerHTML = `
      <h3>🧭 Anàlisi global</h3>
      <p>${escapaHtml(text || "—")}</p>
    `;
    return d;
  }

  function blocAvaluacioPerCriteri(items){
    const d = document.createElement("div");
    d.className = "bloc";
    d.innerHTML = `<h3>🧪 Avaluació per criteri</h3>`;

    if (!Array.isArray(items) || items.length === 0){
      d.innerHTML += `<p class="muted">Sense elements d’avaluació.</p>`;
      return d;
    }

    const files = items.map((it) => {
      const criteri = escapaHtml(it?.criteri ?? "—");
      const complimentRaw = String(it?.compliment ?? "").trim();
      const complimentNorm = normalitza(complimentRaw);
      const badgeClass = ({
        "si":"badge-si", "sí":"badge-si",
        "no":"badge-no",
        "amb reserves":"badge-ar",
      })[complimentNorm] || "badge-na";

      const exemples = Array.isArray(it?.exemples) ? it.exemples : [];
      const exOriginal = escapaHtml(exemples?.[0] || "");
      const exMillorat = escapaHtml(exemples?.[1] || "");

      const justificacio = escapaHtml(it?.justificacio || "");

      return `
        <tr>
          <td class="key">${criteri}</td>
          <td><span class="badge ${badgeClass}">${escapaHtml(complimentRaw || "—")}</span></td>
          <td>
            ${exOriginal || exMillorat ? `
              <ul style="margin:0; padding-left:18px;">
                ${exOriginal ? `<li><strong>Original:</strong> ${exOriginal}</li>` : ""}
                ${exMillorat ? `<li><strong>Millorat:</strong> ${exMillorat}</li>` : ""}
              </ul>
            ` : `<span class="muted">Sense exemples</span>`}
          </td>
          <td>${justificacio || `<span class="muted">Sense justificació</span>`}</td>
        </tr>
      `;
    }).join("");

    d.innerHTML += `
      <table role="table" aria-label="Avaluació per criteri">
        <thead>
          <tr>
            <th scope="col">Criteri</th>
            <th scope="col">Compliment</th>
            <th scope="col">Exemples</th>
            <th scope="col">Justificació</th>
          </tr>
        </thead>
        <tbody>${files}</tbody>
      </table>
    `;

    return d;
  }

  function blocVersioOptimitzada(text){
    const d = document.createElement("div");
    d.className = "bloc";
    const contingut = String(text || "").trim() || "—";

    d.innerHTML = `
      <div class="capsa-cap">
        <h3 style="margin:0;">📝 Versió optimitzada</h3>
        <button class="btn-copia" type="button" id="btnCopyOpt">Copia</button>
      </div>
      <pre class="code" id="versioOpt">${escapaHtml(contingut)}</pre>
    `;

    setTimeout(()=>{
      const btn = d.querySelector("#btnCopyOpt");
      btn?.addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(contingut);
          btn.textContent = "Copiat!";
          setTimeout(()=>btn.textContent = "Copia", 1200);
        }catch{
          btn.textContent = "No s’ha pogut copiar";
          setTimeout(()=>btn.textContent = "Copia", 1500);
        }
      });
    });

    return d;
  }

  function blocJSON(obj){
    const d = document.createElement("div");
    d.className = "bloc";
    d.innerHTML = `
      <h3>📦 Resposta</h3>
      <pre class="code">${escapaHtml(JSON.stringify(obj, null, 2))}</pre>
    `;
    return d;
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // [NOU: FRASE] Render específic per /analisi/frase
  // ─────────────────────────────────────────────────────────────────────────────
  function renderRespostaFrase(res){
    const wrap = document.createElement("div");

    // capçalera amb anàlisi global + KPIs
    const kpis = calculaKPIsFrase(res?.avaluacio_per_criteri || []);
    const cap = document.createElement("div");
    cap.className = "bloc frase-header";
    cap.innerHTML = `
      <div>
        <h3>🧭 Anàlisi global (frase)</h3>
        <p>${escapaHtml(res?.analisi_global || "—")}</p>
      </div>
      <div>
        <div class="kpis" aria-label="Indicadors">
          <div class="kpi">✅ Correctes: ${kpis.ok}</div>
          <div class="kpi">⚠️ Amb reserves: ${kpis.ar}</div>
          <div class="kpi">⛔ No compleix: ${kpis.no}</div>
        </div>
      </div>
    `;
    wrap.appendChild(cap);

    // targetes per criteri
    const llista = Array.isArray(res?.avaluacio_per_criteri) ? res.avaluacio_per_criteri : [];
    if (llista.length === 0){
      const buida = document.createElement("div");
      buida.className = "bloc";
      buida.innerHTML = `<p class="muted">Sense elements d’avaluació.</p>`;
      wrap.appendChild(buida);
    } else {
      llista.forEach((it) => wrap.appendChild(cardCriteriFrase(it)));
    }

    // versió optimitzada (final)
    wrap.appendChild(blocVersioOptimitzada(res?.versio_optimitzada || ""));

    return wrap;
  }

  function calculaKPIsFrase(items){
    let ok=0, ar=0, no=0;
    for (const it of items){
      const v = normalitza(String(it?.compliment || ""));
      if (v === "si" || v === "sí") ok++;
      else if (v === "amb reserves") ar++;
      else if (v === "no") no++;
    }
    return { ok, ar, no };
  }

  function cardCriteriFrase(it){
    const d = document.createElement("div");
    d.className = "criteri-card";

    const nom = String(it?.criteri || "—");
    const complimentRaw = String(it?.compliment || "").trim();
    const complimentNorm = normalitza(complimentRaw);
    const badgeClass = ({
      "si":"badge-si", "sí":"badge-si",
      "no":"badge-no",
      "amb reserves":"badge-ar",
    })[complimentNorm] || "badge-na";

    const exemples = Array.isArray(it?.exemples) ? it.exemples : [];
    const exOriginal = String(exemples?.[0] || "");
    const exMillorat = String(exemples?.[1] || "");
    const justificacio = String(it?.justificacio || "");

    d.innerHTML = `
      <div class="criteri-cap">
        <div><strong>${escapaHtml(nom)}</strong></div>
        <div><span class="badge ${badgeClass}">${escapaHtml(complimentRaw || "—")}</span></div>
      </div>

      <div class="grid-2">
        <div>
          <div class="etiqueta">Original</div>
          <pre class="code">${escapaHtml(exOriginal || "—")}</pre>
        </div>
        <div>
          <div class="etiqueta">Proposta</div>
          <div class="capsa-cap" style="margin:0 0 6px 0;">
            <div></div>
            <button class="btn-copia" type="button">Copia</button>
          </div>
          <pre class="code">${escapaHtml(exMillorat || "—")}</pre>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="etiqueta">Justificació</div>
        <p>${escapaHtml(justificacio || "—")}</p>
      </div>
    `;

    // Acció copiar
    const btn = d.querySelector(".btn-copia");
    const pre = d.querySelectorAll("pre.code")[1];
    btn?.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(exMillorat || "");
        btn.textContent = "Copiat!";
        setTimeout(()=>btn.textContent = "Copia", 1200);
      }catch{
        btn.textContent = "No s’ha pogut copiar";
        setTimeout(()=>btn.textContent = "Copia", 1500);
      }
    });

    return d;
  }

  // [NOU: COMES] Render principal
function renderRespostaComes(res){
  const wrap = document.createElement("div");

  // capçalera amb anàlisi global + KPIs + llegenda
  const kpis = calculaKPIsCompliment(res?.avaluacio_per_criteri || []);
  const perCrit = comptaPerCriteri(res?.avaluacio_per_criteri || []);
  const cap = document.createElement("div");
  cap.className = "bloc comes-header";
  cap.innerHTML = `
    <div>
      <h3>🧭 Anàlisi global (comes)</h3>
      <p>${escapaHtml(res?.analisi_global || "—")}</p>
      <div class="legend" aria-label="Llegenda criteris">
        <span class="tag">Coma obligatòria/incorrecta: ${perCrit.obligatoria_incorrecta}</span>
        <span class="tag">Enumeracions: ${perCrit.enumeracions}</span>
        <span class="tag">Conjuncions: ${perCrit.conjuncions}</span>
        <span class="tag">Incisos/desplaçats: ${perCrit.incisos}</span>
        <span class="tag">Adversatives: ${perCrit.adversatives}</span>
      </div>
    </div>
    <div>
      <div class="kpis" aria-label="Indicadors">
        <div class="kpi">✅ Correctes: ${kpis.ok}</div>
        <div class="kpi">⚠️ Amb reserves: ${kpis.ar}</div>
        <div class="kpi">⛔ No compleix: ${kpis.no}</div>
      </div>
    </div>
  `;
  wrap.appendChild(cap);

  // targetes per criteri
  const llista = Array.isArray(res?.avaluacio_per_criteri) ? res.avaluacio_per_criteri : [];
  if (llista.length === 0){
    const buida = document.createElement("div");
    buida.className = "bloc";
    buida.innerHTML = `<p class="muted">Sense elements d’avaluació.</p>`;
    wrap.appendChild(buida);
  } else {
    llista.forEach((it) => wrap.appendChild(cardCriteriComes(it)));
  }

  // versió optimitzada (final)
  wrap.appendChild(blocVersioOptimitzada(res?.versio_optimitzada || ""));

  return wrap;
}

function cardCriteriComes(it){
  const d = document.createElement("div");
  d.className = "criteri-card";

  const nom = String(it?.criteri || "—");
  const complimentRaw = String(it?.compliment || "").trim();
  const complimentNorm = normalitza(complimentRaw);
  const badgeClass = ({
    "si":"badge-si", "sí":"badge-si",
    "no":"badge-no",
    "amb reserves":"badge-ar",
  })[complimentNorm] || "badge-na";

  const exemples = Array.isArray(it?.exemples) ? it.exemples : [];
  const exOriginal = String(exemples?.[0] || "");
  const exMillorat = String(exemples?.[1] || "");
  const justificacio = String(it?.justificacio || "");

  // ressaltat de comes amb heurística d’afegits/eliminats
  const { oOut, pOut } = ressaltaCanvisComes(exOriginal, exMillorat);

  d.innerHTML = `
    <div class="criteri-cap">
      <div><strong>${escapaHtml(nom)}</strong></div>
      <div><span class="badge ${badgeClass}">${escapaHtml(complimentRaw || "—")}</span></div>
    </div>

    <div class="grid-2">
      <div>
        <div class="etiqueta">Original</div>
        <pre class="code">${oOut || escapaHtml(exOriginal || "—")}</pre>
      </div>
      <div>
        <div class="etiqueta">Proposta</div>
        <div class="capsa-cap" style="margin:0 0 6px 0;">
          <div></div>
          <button class="btn-copia" type="button">Copia</button>
        </div>
        <pre class="code">${pOut || escapaHtml(exMillorat || "—")}</pre>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="etiqueta">Justificació</div>
      <p>${escapaHtml(justificacio || "—")}</p>
    </div>
  `;

  // Acció copiar (copia la proposta sense marques)
  const btn = d.querySelector(".btn-copia");
  btn?.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(exMillorat || "");
      btn.textContent = "Copiat!";
      setTimeout(()=>btn.textContent = "Copia", 1200);
    }catch{
      btn.textContent = "No s’ha pogut copiar";
      setTimeout(()=>btn.textContent = "Copia", 1500);
    }
  });

  return d;
}

  // ─────────────────────────────────────────────────────────────────────────────

  // Render auxiliar en brut
  function blocJSON(obj){
    const d = document.createElement("div");
    d.className = "bloc";
    d.innerHTML = `
      <h3>📦 Resposta</h3>
      <pre class="code">${escapaHtml(JSON.stringify(obj, null, 2))}</pre>
    `;
    return d;
  }
  // [NOU: COMES] — utilitats per comptar i ressaltar
  function calculaKPIsCompliment(items){
    let ok=0, ar=0, no=0;
    for (const it of (items||[])){
      const v = normalitza(String(it?.compliment || ""));
      if (v === "si" || v === "sí") ok++;
      else if (v === "amb reserves") ar++;
      else if (v === "no") no++;
    }
    return { ok, ar, no };
  }

  function mapCriteriId(nom){
    const n = normalitza(String(nom||""));
    if (n.includes("obligatoria") || n.includes("incorrecta")) return "obligatoria_incorrecta";
    if (n.includes("enumeracions")) return "enumeracions";
    if (n.includes("conjuncions")) return "conjuncions";
    if (n.includes("incisos") || n.includes("desplacats") || n.includes("desplaçats")) return "incisos";
    if (n.includes("adversatives")) return "adversatives";
    return "altres";
  }

  function comptaPerCriteri(items){
    const comptador = { obligatoria_incorrecta:0, enumeracions:0, conjuncions:0, incisos:0, adversatives:0, altres:0 };
    for (const it of (items||[])){
      comptador[ mapCriteriId(it?.criteri) ]++;
    }
    return comptador;
  }

  // Ressalta comes: marca totes les comes; si vols, pots fer heurístiques addicionals
  function ressaltaComesBase(text){
    return String(text||"").replace(/,/g, m => `<mark class="coma-plain">,</mark>`);
  }

  // Opcionalment, si vols mostrar "afegit" vs "eliminat" entre original i proposta,
  // pots fer una heurística simple: comes que només són a la proposta => coma-add;
  // comes que només són a l’original => coma-del.
  function ressaltaCanvisComes(original, proposta){
    const o = String(original||"");
    const p = String(proposta||"");
    const oPos = [...o].map((ch,i)=> ch===',' ? i : -1).filter(i=>i>=0);
    const pPos = [...p].map((ch,i)=> ch===',' ? i : -1).filter(i=>i>=0);

    // Conjunt de posicions “semblants” (tolerem desplaçaments petits)
    const matchTol = 2;
    const pMatched = new Set();
    const oMatched = new Set();

    for (let oi of oPos){
      for (let pi of pPos){
        if (Math.abs(oi - pi) <= matchTol && !pMatched.has(pi)){
          oMatched.add(oi); pMatched.add(pi); break;
        }
      }
    }

    // Marca a l’original: comes eliminades (no match) en vermell suau
    let oOut = "";
    for (let i=0;i<o.length;i++){
      const ch = o[i];
      if (ch === ',' && !oMatched.has(i)) oOut += `<mark class="coma-del">,</mark>`;
      else if (ch === ',') oOut += `<mark class="coma-plain">,</mark>`;
      else oOut += escapaHtml(ch);
    }

    // Marca a la proposta: comes afegides (no match) en verd suau
    let pOut = "";
    for (let i=0;i<p.length;i++){
      const ch = p[i];
      if (ch === ',' && !pMatched.has(i)) pOut += `<mark class="coma-add">,</mark>`;
      else if (ch === ',') pOut += `<mark class="coma-plain">,</mark>`;
      else pOut += escapaHtml(ch);
    }

    return { oOut, pOut };
  }

</script>
</body>
</html>
